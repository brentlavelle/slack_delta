require 'slack-ruby-client'
require 'logger'
require_relative 'lib/slack_user'
require_relative 'lib/slack_user_collection'
require 'yaml'

env_var = 'SLACK_TOKEN'
token = ENV[env_var] or raise Exception, "You must set env variable #{env_var} to your slack token"

Slack.configure do |config|
  config.token = token
end

client = Slack::RealTime::Client.new
# client = Slack::Web::Client.new

client.on :hello do
  # logger.info 'successfully connected to slack'
  current_users = SlackUserCollection.new''
  client.users.each do |user_id, slack_user|
    current_users.add_user user_id, SlackUser.new(slack_user)
  end
  File.write('users.yml', current_users.to_yaml)
  # old_users = JSON.parse(IO.read('users-save.yml'))
  old_users = SlackUserCollection.new(IO.read('users-save.yml'))
  old_users.diff(current_users).each do |diff_line|
    print(diff_line, "\n")
  end
end

client.start!
